<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>展開予想盤</title>
    
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png">
    <link rel="icon" href="./favicon.ico">
    <meta name="theme-color" content="#111111">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    
    <style>
        body { 
            touch-action: none; 
            overflow: hidden; 
            background-color: #6b7280; 
        }
        .horse-piece { 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
            will-change: transform;
            overflow: hidden;
        }
        .horse-name {
            font-size: 10px;
            letter-spacing: -0.08em;
            white-space: nowrap;
            line-height: 1;
            display: inline-block;
            transform: scaleX(0.92);
            transform-origin: left;
            font-weight: 900;
        }
        textarea::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const JRA_FRAME_TABLE = {
            5:  [1, 2, 3, 4, 5],
            6:  [1, 2, 3, 4, 5, 6],
            7:  [1, 2, 3, 4, 5, 6, 7],
            8:  [1, 2, 3, 4, 5, 6, 7, 8],
            9:  [1, 2, 3, 4, 5, 6, 7, 8, 8],
            10: [1, 2, 3, 4, 5, 6, 7, 7, 8, 8],
            11: [1, 2, 3, 4, 5, 6, 6, 7, 7, 8, 8],
            12: [1, 2, 3, 4, 5, 5, 6, 6, 7, 7, 8, 8],
            13: [1, 2, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8],
            14: [1, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8],
            15: [1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8],
            16: [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8],
            17: [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 8],
            18: [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 7, 8, 8, 8]
        };

        const FRAME_COLORS = [
            { bg: '#FFFFFF', text: '#000000' }, { bg: '#000000', text: '#FFFFFF' },
            { bg: '#ef4444', text: '#FFFFFF' }, { bg: '#3b82f6', text: '#FFFFFF' },
            { bg: '#fbbf24', text: '#000000' }, { bg: '#22c55e', text: '#FFFFFF' },
            { bg: '#f97316', text: '#000000' }, { bg: '#f472b6', text: '#000000' }
        ];

        const App = () => {
            const [numHorses, setNumHorses] = useState(16);
            const [horses, setHorses] = useState([]);
            const [history, setHistory] = useState([]);
            const [redoStack, setRedoStack] = useState([]);
            const [horseNames, setHorseNames] = useState("");
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isNameEditOpen, setIsNameEditOpen] = useState(false);
            
            const [transform, setTransform] = useState({ x: 0, y: 0, scale: 1 });
            const [draggingId, setDraggingId] = useState(null);

            const containerRef = useRef(null);
            const lastTouchRef = useRef(null);
            const dragStartPos = useRef({ x: 0, y: 0, horseX: 0, horseY: 0 });

            const initHorses = useCallback((count) => {
                const frames = JRA_FRAME_TABLE[count];
                const pieceWidth = 96;
                const startX = (window.innerWidth - pieceWidth) / 2;
                const names = horseNames.split(/[\n,、\s\t]+/).filter(n => n.trim() !== "");

                const newHorses = Array.from({ length: count }, (_, i) => {
                    const num = i + 1;
                    const frameNum = frames[i];
                    const colorInfo = FRAME_COLORS[frameNum - 1];
                    return { 
                        id: num, number: num, name: names[i] || ``, 
                        x: startX, y: 40 + i * 44, 
                        color: colorInfo.bg, textColor: colorInfo.text 
                    };
                });
                setHorses(newHorses);
                setHistory([]);
                setRedoStack([]);
                setTransform({ x: 0, y: 0, scale: 1 });
            }, [horseNames]);

            useEffect(() => {
                initHorses(numHorses);
            }, []);

            useEffect(() => {
                const names = horseNames.split(/[\n,、\s\t]+/).filter(n => n.trim() !== "");
                setHorses(prev => prev.map((h, i) => ({ ...h, name: names[i] || "" })));
            }, [horseNames]);

            const saveState = () => {
                setHistory(prev => [...prev.slice(-99), JSON.stringify(horses)]);
                setRedoStack([]);
            };

            const undo = () => {
                if (history.length === 0) return;
                const prevState = JSON.parse(history[history.length - 1]);
                setRedoStack(prev => [...prev, JSON.stringify(horses)]);
                setHorses(prevState);
                setHistory(prev => prev.slice(0, -1));
            };

            const redo = () => {
                if (redoStack.length === 0) return;
                const nextState = JSON.parse(redoStack[redoStack.length - 1]);
                setHistory(prev => [...prev, JSON.stringify(horses)]);
                setHorses(nextState);
                setRedoStack(prev => prev.slice(0, -1));
            };

            const handleHorseTouchStart = (e, horse) => {
                e.stopPropagation();
                saveState();
                const touch = e.touches[0];
                setDraggingId(horse.id);
                dragStartPos.current = {
                    x: touch.clientX, y: touch.clientY,
                    horseX: horse.x, horseY: horse.y
                };
            };

            const handleTouchMove = (e) => {
                if (draggingId) {
                    const touch = e.touches[0];
                    const dx = (touch.clientX - dragStartPos.current.x) / transform.scale;
                    const dy = (touch.clientY - dragStartPos.current.y) / transform.scale;
                    if (isNaN(dx) || isNaN(dy)) return;
                    setHorses(prev => prev.map(h => 
                        h.id === draggingId ? { 
                            ...h, x: dragStartPos.current.horseX + dx, y: dragStartPos.current.horseY + dy 
                        } : h
                    ));
                } else if (e.touches.length === 2) {
                    const t1 = e.touches[0];
                    const t2 = e.touches[1];
                    const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
                    if (lastTouchRef.current?.dist && dist > 0) {
                        const ratio = dist / lastTouchRef.current.dist;
                        setTransform(prev => {
                            const newScale = Math.min(Math.max(prev.scale * ratio, 0.2), 6);
                            return isNaN(newScale) ? prev : { ...prev, scale: newScale };
                        });
                    }
                    lastTouchRef.current = { dist };
                } else if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    if (lastTouchRef.current?.x) {
                        const dx = touch.clientX - lastTouchRef.current.x;
                        const dy = touch.clientY - lastTouchRef.current.y;
                        if (!isNaN(dx) && !isNaN(dy)) {
                            setTransform(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
                        }
                    }
                    lastTouchRef.current = { x: touch.clientX, y: touch.clientY };
                }
            };

            const handleTouchEnd = () => {
                setDraggingId(null);
                lastTouchRef.current = null;
            };

            return (
                <div className="flex flex-col h-screen text-white overflow-hidden font-sans select-none">
                    <header className="flex items-center justify-between gap-1 p-2 bg-slate-900 shadow-xl z-20 h-16 border-b border-slate-800">
                        <div className="flex flex-1 gap-1 h-full">
                            <button onClick={undo} disabled={history.length === 0} className={`flex-1 flex items-center justify-center rounded-lg ${history.length === 0 ? 'opacity-20 bg-slate-800' : 'bg-slate-700 active:bg-slate-600'}`}>
                                <i className="fa-solid fa-rotate-left scale-125"></i>
                            </button>
                            <button onClick={redo} disabled={redoStack.length === 0} className={`flex-1 flex items-center justify-center rounded-lg ${redoStack.length === 0 ? 'opacity-20 bg-slate-800' : 'bg-slate-700 active:bg-slate-600'}`}>
                                <i className="fa-solid fa-rotate-right scale-125"></i>
                            </button>
                        </div>
                        <div className="px-4 text-center">
                            <div className="text-xl font-black text-slate-100 truncate tracking-tight">展開</div>
                        </div>
                        <div className="flex flex-1 gap-1 h-full">
                            <button onClick={() => setIsNameEditOpen(true)} className="flex-1 flex items-center justify-center bg-slate-700 rounded-lg active:bg-slate-600">
                                <i className="fa-solid fa-font scale-125"></i>
                            </button>
                            <button onClick={() => setIsSettingsOpen(true)} className="flex-1 flex items-center justify-center bg-slate-700 rounded-lg active:bg-slate-600">
                                <i className="fa-solid fa-gear scale-125"></i>
                            </button>
                        </div>
                    </header>

                    <main ref={containerRef} className="flex-1 relative bg-gray-500" onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                        <div className="absolute inset-0 origin-top-left" style={{ transform: `translate3d(${transform.x}px, ${transform.y}px, 0) scale(${transform.scale})` }}>
                            {horses.map(h => (
                                <div key={h.id} 
                                     className={`horse-piece absolute w-[96px] h-10 rounded-xl shadow-md border border-black/30 ${draggingId === h.id ? 'z-50 ring-2 ring-white scale-110' : 'z-10'}`}
                                     style={{ left: h.x, top: h.y, backgroundColor: h.color }}
                                     onTouchStart={(e) => handleHorseTouchStart(e, h)}>
                                    
                                    <div className="absolute right-0 bottom-[-2px] text-4xl font-black italic pointer-events-none pr-1"
                                         style={{ color: h.color === '#FFFFFF' ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.35)' }}>
                                        {h.number}
                                    </div>

                                    <div className="absolute inset-0 flex items-center px-1.5 z-10 overflow-hidden" style={{ color: h.textColor }}>
                                        <span className="horse-name font-black uppercase">
                                            {h.name}
                                        </span>
                                    </div>
                                    <div className="absolute bottom-0 left-0 w-full h-[2px] opacity-10" style={{ backgroundColor: h.textColor }}></div>
                                </div>
                            ))}
                        </div>

                        <button onClick={() => setTransform({ x: 0, y: 0, scale: 1 })} className="absolute bottom-8 right-8 p-5 bg-slate-900/90 backdrop-blur rounded-full shadow-2xl z-10 border border-slate-700 active:scale-90">
                            <i className="fa-solid fa-expand text-emerald-400 scale-150"></i>
                        </button>
                    </main>

                    {/* 頭数設定モーダル */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setIsSettingsOpen(false)}>
                            <div className="bg-slate-800 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h2 className="text-lg font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                    <i className="fa-solid fa-gear text-sm"></i> 出走頭数
                                </h2>
                                <div className="grid grid-cols-4 gap-2">
                                    {Object.keys(JRA_FRAME_TABLE).map(numStr => {
                                        const val = parseInt(numStr);
                                        return (
                                            <button
                                                key={val}
                                                onClick={() => {
                                                    setNumHorses(val);
                                                    initHorses(val);
                                                    setIsSettingsOpen(false);
                                                }}
                                                className={`py-3 rounded-xl font-bold border-2 transition-all active:scale-90 ${numHorses === val ? 'bg-emerald-600 border-emerald-400 text-white shadow-lg shadow-emerald-900/50' : 'bg-slate-900 border-slate-700 text-slate-400'}`}
                                            >
                                                {val}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 馬名設定モーダル */}
                    {isNameEditOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setIsNameEditOpen(false)}>
                            <div className="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border border-slate-700 shadow-2xl overflow-y-auto max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-black mb-4 text-slate-100 flex items-center gap-2">
                                    <i className="fa-solid fa-font text-emerald-400"></i> 馬名設定
                                </h2>

                                <textarea 
                                    id="name-textarea"
                                    value={horseNames} 
                                    onChange={(e) => setHorseNames(e.target.value)} 
                                    className="w-full h-[480px] bg-slate-950 border-2 border-slate-700 rounded-2xl p-4 text-base focus:border-emerald-500 focus:outline-none font-mono text-white placeholder:text-slate-700 mb-4 transition-colors" 
                                    placeholder="長押しして馬名を貼り付け" 
                                />

                                <div className="grid grid-cols-3 gap-2">
                                    <a 
                                        href="https://www.jra.go.jp/" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="py-4 bg-slate-900 text-slate-100 rounded-2xl font-black border-2 border-slate-700 active:bg-slate-700 active:scale-95 flex items-center justify-center text-xl transition-all"
                                    >
                                        JRA
                                    </a>
                                    <a 
                                        href="https://chatgpt.com/g/g-6953a1816fb8819196c5825920450773-chu-zou-ma-ming-chou-chu-xi-san" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="py-4 bg-slate-900 text-slate-100 rounded-2xl font-black border-2 border-slate-700 active:bg-slate-700 active:scale-95 flex items-center justify-center text-xl transition-all"
                                    >
                                        整形
                                    </a>
                                    <button 
                                        onClick={() => setHorseNames("")}
                                        className="py-4 bg-slate-900 text-rose-500 rounded-2xl font-black border-2 border-slate-800 active:bg-rose-950/30 active:border-rose-900 active:scale-95 transition-all flex items-center justify-center text-xl"
                                    >
                                        消去
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>